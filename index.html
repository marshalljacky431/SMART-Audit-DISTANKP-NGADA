import React, { useState } from "react";
import { Card, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { BarChart, Bar, XAxis, YAxis, Tooltip, Legend, ResponsiveContainer } from "recharts";
import { Textarea } from "@/components/ui/textarea";
import jsPDF from "jspdf";
import autoTable from "jspdf-autotable";

export default function DashboardAudit() {
  const [data, setData] = useState([
    { akun: "Belanja Barang", anggaran: 3000000, realisasi: 2500000 },
    { akun: "PAD Retribusi", anggaran: 2000000, realisasi: 3000000 }
  ]);

  const [form, setForm] = useState({ akun: "", anggaran: 0, realisasi: 0 });

  const handleChange = (e) => {
    const { name, value } = e.target;
    setForm({ ...form, [name]: value });
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    const newEntry = {
      akun: form.akun,
      anggaran: parseFloat(form.anggaran),
      realisasi: parseFloat(form.realisasi)
    };
    setData([...data, newEntry]);
    setForm({ akun: "", anggaran: 0, realisasi: 0 });
  };

  const generatePDF = () => {
    const doc = new jsPDF();
    doc.text("Laporan Serapan Anggaran", 14, 16);
    const tableData = data.map(item => {
      const persentase = ((item.realisasi / item.anggaran) * 100).toFixed(1);
      let status = "Kurang Efisien";
      if (persentase > 100) status = "Over Budget";
      else if (persentase > 80) status = "Optimal";
      return [item.akun, item.anggaran, item.realisasi, `${persentase}%`, status];
    });
    autoTable(doc, {
      head: [["Akun", "Anggaran", "Realisasi", "% Serapan", "Status"]],
      body: tableData,
    });
    doc.save("laporan-serapan-anggaran.pdf");
  };

  return (
    <div className="p-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
      <Card className="col-span-2">
        <CardContent>
          <h2 className="text-xl font-bold mb-2">Dashboard Serapan Anggaran</h2>
          <ResponsiveContainer width="100%" height={300}>
            <BarChart data={data}>
              <XAxis dataKey="akun" />
              <YAxis />
              <Tooltip />
              <Legend />
              <Bar dataKey="anggaran" fill="#8884d8" name="Anggaran" />
              <Bar dataKey="realisasi" fill="#82ca9d" name="Realisasi" />
            </BarChart>
          </ResponsiveContainer>
        </CardContent>
      </Card>

      <Card>
        <CardContent>
          <h2 className="text-xl font-bold mb-2">Tambah Transaksi</h2>
          <form className="space-y-2" onSubmit={handleSubmit}>
            <Input name="akun" value={form.akun} onChange={handleChange} placeholder="Kode/Nama Akun" required />
            <Input name="anggaran" value={form.anggaran} onChange={handleChange} placeholder="Anggaran" type="number" required />
            <Input name="realisasi" value={form.realisasi} onChange={handleChange} placeholder="Realisasi" type="number" required />
            <Button type="submit">Tambah</Button>
          </form>
        </CardContent>
      </Card>

      <Card className="col-span-3">
        <CardContent>
          <div className="flex justify-between items-center mb-2">
            <h2 className="text-xl font-bold">Audit Catatan AI (Simulasi)</h2>
            <Button onClick={generatePDF}>Export PDF</Button>
          </div>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            {data.map((item, index) => {
              const persentase = (item.realisasi / item.anggaran) * 100;
              let status = "Kurang Efisien";
              if (persentase > 100) status = "Over Budget";
              else if (persentase > 80) status = "Optimal";
              return (
                <div key={index} className="p-2 border rounded-xl bg-gray-50 shadow-sm">
                  <p><strong>{item.akun}</strong></p>
                  <p>Serapan: {persentase.toFixed(1)}%</p>
                  <p>Status: <span className="font-semibold">{status}</span></p>
                </div>
              );
            })}
          </div>
        </CardContent>
      </Card>
    </div>
  );
}
